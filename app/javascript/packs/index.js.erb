import React, {useEffect, useState} from 'react'
import ReactDOM from 'react-dom'
import App from "../base/App";
import I18n from "i18n-js"; import Loader from "../base/Loader"; import Api from "../base/Api";

I18n.translations = <%= I18n::JS.translations.to_json %>;

/* React entrypoint */
document.addEventListener('DOMContentLoaded', () => {

    let rendered = false;
    Api({path: '/hi'}).then(
        res => {
            if (res.status === 200) {
                res.json().then(
                    json => {
                        if (json.username && json.bio) {
                            console.log(I18n.t('console.authorized') + JSON.stringify(json));
                            rendered=true;
                            ReactDOM.render(<App account={json}/>, document.getElementById('app'));
                        } else {
                            console.error(I18n.t('console.error') + ' Unknown JSON returned: ' + JSON.stringify(json)) // TODO: error handling
                        }
                    }, err => {
                        console.error(I18n.t('console.error') + JSON.stringify(err)) // TODO: error handling
                    });
            }
        },
        err => {
            console.error(I18n.t('console.error') + JSON.stringify(err)) // TODO: error handling
        }
    ).then(
        () => {
            if(!rendered)  {
                ReactDOM.render(<App account={undefined}/>, document.getElementById('app')); // this should come last
            }
        }
    ).then(() => {
        const loader = document.getElementById('loader');
        if (loader.classList.contains('initial')) {
            loader.remove();
        }
    })
});
